## Determination of reaction orders.

```{python}
#| code-fold: true
import matplotlib.pyplot as plt
import numpy as np
import pandas as pd
from scipy.optimize import curve_fit
from fysisk_biokemi.widgets import DataUploader
from IPython.display import display 
pd.set_option('display.max_rows', 6)
```

You have carried out a kinetic experiment investigating the turnover of two metabolites, A1 and A2, in a cell lysate. For each metabolite, you have measured the concentration of the compound as a function of time using UV-Vis spectroscopy aiming to determine the reaction order, and thus deduce something about the reaction mechanism by which they are processed. The date from this experiment is found in `reaction-orders.xlsx`.

#### (a) Load the dataset

Load the dataset `reaction-orders.xlsx` using the widget below

```{python}
#| eval: false
uploader = DataUploader()
uploader.display()
```

Run the next cell **after** uploading the file

```{python}
#| eval: false
df = uploader.get_dataframe()
display(df)
```

```{python}
#| solution: true
from fysisk_biokemi.datasets import load_dataset
df = load_dataset('reaction_order_week48') # Load from package for the solution so it doesn't require to interact.
display(df)
```

#### (b) SI units. 

Add two new columns with the concentrations given in M. 

```{python}
#| exercise: true
#| eval: false

## Your task: Add new columns with the A1_M and A2_M. 
...
...

display(df)
```

```{python}
#| solution: true
df['A1_M'] = df['A1_uM'] * 10**(-6)
df['A2_M'] = df['A2_uM'] * 10**(-6)
display(df)
```

#### (c) Plotting 

For each reactant make a plot of the concentration versus time.

```{python}
#| exercise: true
#| eval: false
fig, ax = plt.subplots() 

## Your task: Make plots of concentration (y) versus time (x). ##
## Hint: ax.plot(x_data, y_data, 'o') to make a scatter plot.
...
...

## EXTRA: Customization of axis labels ##
ax.set_xlabel('Time [s]')
ax.set_ylabel('Concentration')
```

```{python}
#| solution: true
#| fig-align: center
fig, ax = plt.subplots() 

## Your task: Make plots of concentration (y) versus time (x). ##
## Hint: ax.plot(x_data, y_data, 'o') to make a scatter plot. ##
ax.plot(df['Time_s'], df['A1_M'], 'o')
ax.plot(df['Time_s'], df['A2_M'], 'o')

## EXTRA: Customization of axis labels ##
ax.set_xlabel('Time [s]')
ax.set_ylabel('Concentration')
```

#### (d) Model as N'th-order reaction

We can start by modelling both reactions as zeroths order. We will consider both the 
the rate constant $k$ and the concentration at time $t = 0$ parameters. 

```{python}
#| exercise: true
#| eval: false
def zeroth_order(t, k, A0):
    ## Your task: Implement the zeroth order rate equation ##
    concentration = ...
    return concentration

def first_order(t, k, A0):
    ## Your task: Implement the first order rate equation ##
    result = ...
    return result

def second_order(t, k, A0):
    ## Your task: Implement the second order rate equation ##
    result = ...
    return result
```

```{python}
#| solution: true
def zeroth_order(t, k, A0):
    ## Your task: Implement the zeroth order rate equation ##
    concentration = A0 - k*t
    return concentration

def first_order(t, k, A0):
    ## Your task: Implement the first order rate equation ##
    return A0 * np.exp(-k*t)

def second_order(t, k, A0):
    ## Your task: Implement the second order rate equation ##
    return A0 / (1 + 2*k*t*A0)
```

Then we can make a fit to measurements of each reactant. 

```{python}
#| exercise: true
#| eval: false

## Your task: Pick a rate equation and assign it to the variable rate_equation
## You can change this to first_order or second_order
## Do not call the function - so no (...) just assign it to the variable.
rate_equation = zeroth_order 

## Your task: Make a fit of the A1_M data with 'rate_equation'.
fitted_parameters_A1, trash = ...
k_A1_fit = fitted_parameters_A1[0]
A1_0_fit = fitted_parameters_A1[1]

## Your task: Make a fit of the A2_M with 'rate_equation'.
fitted_parameters_A2, trash = ...
k_A2_fit = fitted_parameters_A2[0]
A2_0_fit = fitted_parameters_A2[1]

## Prints the found parameters
print(k_A1_fit)
print(A1_0_fit)

print(k_A2_fit)
print(A2_0_fit)
```

```{python}
#| solution: true

## Your task: Pick a rate equation and assign it to the variable rate_equation
## You can change this to first_order or second_order
## Do not call the function - so no (...) just assign it to the variable.
rate_equation = zeroth_order

## Your task: Make a fit of the A1_M data with 'rate_equation'.
fitted_parameters_A1, trash = curve_fit(rate_equation, df['Time_s'], df['A1_M'])    
k_A1_fit = fitted_parameters_A1[0]
A1_0_fit = fitted_parameters_A1[1]

## Your task: Make a fit of the A2_M with 'rate_equation'.
fitted_parameters_A2, trash = curve_fit(rate_equation, df['Time_s'], df['A2_M'])
k_A2_fit = fitted_parameters_A2[0]
A2_0_fit = fitted_parameters_A2[1]

## Prints the found parameters
print(k_A1_fit)
print(A1_0_fit)

print(k_A2_fit)
print(A2_0_fit)
```

Now that we fitted the data using one of the rate equations, we can plot to see how well it fits

```{python}
#| exercise: true
#| eval: false

fig, ax = plt.subplots() 


## Your task: Finish the code to calculate the fit for A2.
t_smooth = np.linspace(0, 55)
A1_fit = rate_equation(t_smooth, k_A1_fit, A1_0_fit)
A2_fit = ...


## Your task: Plot the fits 
...
...

## Plots the data ##
ax.plot(df['Time_s'], df['A1_M'], 'o')
ax.plot(df['Time_s'], df['A2_M'], 'o')

## EXTRA: Customization of axis labels ##
ax.set_xlabel('Time [s]')
ax.set_ylabel('Concentration')
```

```{python}
#| solution: true
#| fig-align: center
fig, ax = plt.subplots() 

t_smooth = np.linspace(0, 55)
A1_fit = rate_equation(t_smooth, k_A1_fit, A1_0_fit)
A2_fit = rate_equation(t_smooth, k_A2_fit, A2_0_fit)

## Your task: Plot the fits 
ax.plot(t_smooth, A1_fit)
ax.plot(t_smooth, A2_fit)

## Plots the data ##
ax.plot(df['Time_s'], df['A1_M'], 'o')
ax.plot(df['Time_s'], df['A2_M'], 'o')

## EXTRA: Customization of axis labels ##
ax.set_xlabel('Time [s]')
ax.set_ylabel('Concentration')
```

Once you've finished the fitting with one of the rate equations you can go back 
and change the `rate_equation` variable to try one of the others. 

#### (f) Determining reaction orders

The cell below makes a plot for each rate law in the same panel using your 
defined rate equations. 

```{python}
#| exercise: true
#| eval: false
from fysisk_biokemi.utils.deter_reacti_orders import make_plot
rate_laws = {0: zeroth_order, 1: first_order, 2: second_order}
make_plot(df, rate_laws)
```


```{python}
#| solution: true
from fysisk_biokemi.utils.deter_reacti_orders import make_plot
rate_laws = {0: zeroth_order, 1: first_order, 2: second_order}
make_plot(df, rate_laws)
```

Based on this plot; 

1. What is the reaction order for [A1]?
2. What is the unit of the rate constant for [A1]? 
3. What is the reaction order for [A2]?
4. What is the unit of the rate constant for [A2]? 

```{python}
#| solution: true
#| output: asis
#| echo: false
answer=r"""
::: {.callout-important}

## Answer

1. First order
2. The unit of the rate contant for a first order reaction is $\frac{1}{\text{s}}$

The first order rate equation is 

$$
A_0 \cdot \exp({-k\cdot t})
$$

The term in the exponential has to be unitless, so we need $k$ to have the inverse units of $t$

$$
k \rightarrow \frac{1}{t} \rightarrow \frac{1}{\text{s}}
$$


3. Second order
4. The unit of the rate contant for a second order reaction is $\frac{1}{\text{s} \cdot \text{M}}$

The integrated second order rate is 

$$
\frac{A_0}{1 + 2\cdot k \cdot t \cdot A_0}
$$

Looking at the denominator it includes the term
$$
1 + 2\cdot k \cdot t \cdot A_0
$$
For this addition to make sense the second term needs to be unitless, so we have 
can conclude that the unit of $k$ must cancel those of $t \cdot A_0$, so 

$$
k \rightarrow \frac{1}{t \cdot A_0} \rightarrow \frac{1}{\text{s} \cdot \text{M}}
$$

:::
"""
print(answer)
```

#### (e) Reaction mechanism

What does the above tell you about the reaction mechanism whereby the two compounds
disappear from the lysate?

```{python}
#| solution: true
#| output: asis
#| echo: false
answer=r"""
::: {.callout-important}

## Answer

:::
"""
print(answer)
```